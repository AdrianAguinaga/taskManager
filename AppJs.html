<script>
(() => {
  // --- DECLARACIÃ“N DE VARIABLES ---
  let modal, form, btnNew, btnRefresh, btnDelete, btnTheme, btnCancel, debugPanel, board;
  let columns = {};
  let tasks = [];

  const $ = (sel, root = document) => root.querySelector(sel);
  
  // =================================================================
  // INICIALIZACIÃ“N DE LA APLICACIÃ“N
  // =================================================================
  
  window.addEventListener('load', () => {
    modal = document.getElementById('taskModal');
    form = document.getElementById('taskForm');
    btnNew = document.getElementById('btnNew');
    btnRefresh = document.getElementById('btnRefresh');
    btnDelete = document.getElementById('btnDelete');
    btnTheme = document.getElementById('btnTheme');
    btnCancel = document.getElementById('btnCancel');
    debugPanel = document.getElementById('debugPanel');
    board = document.getElementById('board');

    columns = {
      'Backlog': document.getElementById('col-Backlog'),
      'In Progress': document.getElementById('col-In-Progress'),
      'Review': document.getElementById('col-Review'),
      'Done': document.getElementById('col-Done')
    };
    
    setDebug('AplicaciÃ³n iniciada.');
    
    try {
      btnTheme.addEventListener('click', toggleTheme);
      btnNew.addEventListener('click', () => openModal());
      btnRefresh.addEventListener('click', refresh);
      btnDelete.addEventListener('click', onDelete);
      btnCancel.addEventListener('click', () => modal.close());
      form.addEventListener('submit', onSubmit);
      
      board.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-assign')) {
          quickAssign(e.target.dataset.taskId);
        }
        if (e.target.classList.contains('review-flag')) {
          toggleReviewFlag(e.target.dataset.taskId);
        }
      });

      setDebug('Event listeners configurados.');
    } catch (error) {
      setDebug('Error al configurar listeners', error.message);
      return;
    }
    
    refresh();
  });

  function refresh() {
    setDebug('Actualizando tareas...');
    google.script.run
      .withFailureHandler(err => { 
        setDebug('Error al obtener tareas', String(err));
        alert('Error al cargar las tareas: ' + err); 
      })
      .withSuccessHandler(rows => {
        tasks = Array.isArray(rows) ? rows : [];
        render();
      })
      .apiGetTasks();
  }

  function render() {
    setDebug(`Renderizando ${tasks.length} tareas...`);
    Object.values(columns).forEach(col => { col.innerHTML = ''; });

    if (tasks.length > 0) {
        tasks.forEach(task => {
            const card = buildCard(task);
            const targetColumn = columns[task.status] || columns['Backlog'];
            if (targetColumn) targetColumn.appendChild(card);
        });
    }

    Object.values(columns).forEach(col => {
      col.addEventListener('dragover', onDragOver);
      col.addEventListener('dragleave', onDragLeave);
      col.addEventListener('drop', onDrop);
    });
  }

  function buildCard(t) {
    const el = document.createElement('article');
    el.className = 'card';
    el.draggable = true;
    el.dataset.id = t.id;
    
    let avatarsHtml = '<div class="avatars">';
    if (t.assignee) {
      const assignees = t.assignee.split(',').map(name => name.trim()).filter(Boolean);
      assignees.forEach(name => {
        const { bgColor, textColor } = getColorForName(name);
        avatarsHtml += `<span class="avatar" style="background-color: ${bgColor}; color: ${textColor};" title="${escapeHtml(name)}">${initials(name)}</span>`;
      });
    } else {
      avatarsHtml += `<span class="avatar-empty" title="Sin asignar"></span>`;
    }
    avatarsHtml += '</div>';
    
    el.innerHTML = `
      <div class="card-header">
        <div class="meta">
          <span class="badge">#${t.id}</span>
          <span class="badge">
            <span class="dot ${prioClass(t.priority)}"></span>${t.priority}
          </span>
          ${t.needsReview ? `<span class="review-flag" data-task-id="${t.id}" title="Necesita RevisiÃ³n. Haz clic para quitar.">ðŸš©</span>` : ''}
        </div>
        <div class="card-actions">
          ${avatarsHtml}
          <button class="btn-assign" data-task-id="${t.id}" title="Asignarme a esta tarea">+</button>
        </div>
      </div>
      <div class="title">${escapeHtml(t.title)}</div>
      ${t.description ? `<div class="desc">${escapeHtml(t.description)}</div>` : ''}
    `;
    
    el.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', String(t.id)));
    el.addEventListener('dblclick', () => openModal(t));
    return el;
  }

  function quickAssign(taskId) {
    const nombre = prompt("Escribe tu nombre para asignarte:", "");
    if (!nombre || !taskId) return;
    google.script.run
      .withFailureHandler(err => alert('Error: ' + err.message))
      .withSuccessHandler(refresh)
      .apiAssignTaskToUser(Number(taskId), nombre.trim());
  }

  function toggleReviewFlag(taskId) {
    if (!taskId) return;
    google.script.run
      .withFailureHandler(err => alert('Error: ' + err.message))
      .withSuccessHandler(refresh)
      .apiToggleReviewFlag(Number(taskId));
  }

  function onSubmit(e) {
    e.preventDefault();
    const payload = {
      id: Number($('#taskId').value || 0),
      title: $('#title').value.trim(),
      description: $('#description').value.trim(),
      priority: $('#priority').value,
      assignee: $('#assignee').value.trim(),
      status: $('#status').value,
      // CAMBIO: Se obtiene el estado del checkbox de revisiÃ³n
      needsReview: $('#needsReview').checked
    };
    if (!payload.title) return alert('El tÃ­tulo es obligatorio.');
    
    const userPassword = prompt('Ingresa la contraseÃ±a para guardar:');
    if (userPassword === null) return;

    const saveButton = $('#btnSave');
    const originalButtonText = saveButton.textContent;
    saveButton.textContent = 'Guardando...';
    saveButton.disabled = true;

    const onFinish = (error = null) => {
      saveButton.textContent = originalButtonText;
      saveButton.disabled = false;
      if (error) return alert('Error: ' + error);
      modal.close();
      refresh();
    };
    
    if (payload.id) {
      google.script.run.withFailureHandler(onFinish).withSuccessHandler(() => onFinish()).apiUpdateTask({ task: payload, password: userPassword });
    } else {
      google.script.run.withFailureHandler(onFinish).withSuccessHandler(() => onFinish()).apiCreateTask({ task: payload, password: userPassword });
    }
  }

  function onDelete() {
    const id = Number($('#taskId').value);
    if (!id || !confirm('Â¿Seguro que quieres eliminar esta tarea?')) return;
    const userPassword = prompt('Ingresa la contraseÃ±a para ELIMINAR:');
    if (userPassword === null) return;
    google.script.run
      .withFailureHandler(err => alert('Error al eliminar: ' + err))
      .withSuccessHandler(() => { modal.close(); refresh(); })
      .apiDeleteTask({ id: id, password: userPassword });
  }

  function openModal(task = null) {
    form.reset();
    $('#taskId').value = task?.id || '';
    $('#title').value = task?.title || '';
    $('#description').value = task?.description || '';
    $('#priority').value = task?.priority || 'Medium';
    $('#assignee').value = task?.assignee || '';
    $('#status').value = task?.status || 'Backlog';
    // CAMBIO: Se establece el valor del checkbox al abrir el modal
    $('#needsReview').checked = task?.needsReview || false;
    $('#modalTitle').textContent = task ? `Editar tarea #${task.id}` : 'Nueva tarea';
    btnDelete.style.display = task ? 'inline-block' : 'none';
    modal.showModal();
  }

  function onDrop(e) {
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const status = e.currentTarget.closest('.column').dataset.status;
    e.currentTarget.classList.remove('dragover');
    const card = $(`[data-id="${id}"]`);
    if (card) e.currentTarget.appendChild(card);
    google.script.run.withFailureHandler(() => refresh()).withSuccessHandler(refresh).apiMoveTask(Number(id), status);
  }

  function onDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
  function onDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
  
  function getColorForName(name) {
    const colors = ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    const bgColor = colors[Math.abs(hash % colors.length)];
    const r = parseInt(bgColor.slice(1, 3), 16), g = parseInt(bgColor.slice(3, 5), 16), b = parseInt(bgColor.slice(5, 7), 16);
    const textColor = ((r * 299 + g * 587 + b * 114) / 1000) > 155 ? '#111827' : '#ffffff';
    return { bgColor, textColor };
  }

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    document.documentElement.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
  }

  function prioClass(p) { return String(p || '').toLowerCase(); }
  function initials(name) { return String(name).trim().split(' ').map(p => p[0] || '').slice(0, 2).join('').toUpperCase() || 'â€”'; }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
  
  function setDebug(msg, obj) {
    if (!debugPanel) return; 
    const time = new Date().toLocaleTimeString();
    let content = `[${time}] ${msg}`;
    if (obj) content += `\n${JSON.stringify(obj, null, 2)}`;
    debugPanel.textContent = content;
  }
})();
</script>
