<script>
(() => {
  // =================================================================
  // ESTADO
  // =================================================================
  let modal, form, btnNew, btnRefresh, btnDelete, btnTheme, btnCancel, debugPanel, board;
  let descModal; // modal de descripción expandida
  const columns = {};
  let tasks = [];
  let dragging = null; // { card: HTMLElement, fromStatus: string }

  const $ = (sel, root = document) => root.querySelector(sel);

  // =================================================================
  // INIT
  // =================================================================
  window.addEventListener('load', () => {
    modal       = $('#taskModal');
    form        = $('#taskForm');
    btnNew      = $('#btnNew');
    btnRefresh  = $('#btnRefresh');
    btnDelete   = $('#btnDelete');
    btnTheme    = $('#btnTheme');
    btnCancel   = $('#btnCancel');
    debugPanel  = $('#debugPanel');
    board       = $('#board');

    // Crear modal para descripción expandida si no existe
    descModal = document.createElement('dialog');
    descModal.id = 'descModal';
    descModal.innerHTML = `
      <div class="desc-header">
        <strong>Descripción</strong>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="descCopyBtn" title="Copiar texto">Copiar</button>
          <button class="btn primary" id="descCloseBtn">Cerrar</button>
        </div>
      </div>
      <div class="desc-body" id="descBody"></div>
    `;
    document.body.appendChild(descModal);
    $('#descCloseBtn', descModal).addEventListener('click', () => descModal.close());
    $('#descCopyBtn', descModal).addEventListener('click', () => {
      const el = $('#descBody', descModal);
      const text = el.innerText || el.textContent || '';
      navigator.clipboard.writeText(text).catch(()=>{});
    });

    // Mapea columnas por estatus (coincide con Index.html)
    columns['Backlog']     = $('#col-Backlog');
    columns['In Progress'] = $('#col-In-Progress');
    columns['Review']      = $('#col-Review');
    columns['Done']        = $('#col-Done');

    // Botón de archivar en “Hecho”
    injectArchiveButton();

    // Listeners base
    btnTheme?.addEventListener('click', toggleTheme);
    btnNew?.addEventListener('click', () => openModal());
    btnRefresh?.addEventListener('click', refresh);
    btnDelete?.addEventListener('click', onDelete);
    btnCancel?.addEventListener('click', () => modal.close());
    form?.addEventListener('submit', onSubmit);

    // Evitar selección de texto en drag
    window.addEventListener('dragstart', () => document.body.classList.add('dragging'));
    window.addEventListener('dragend',   () => document.body.classList.remove('dragging'));

    // Persistencia de tema
    loadTheme();

    setDebug('Aplicación iniciada.');
    refresh();
  });

  // =================================================================
  // TEMA (persistente)
  // =================================================================
  function loadTheme() {
    const saved = localStorage.getItem('lide.theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
  }
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = current === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('lide.theme', next);
  }

  // =================================================================
  // BOTÓN ARCHIVAR “HECHO”
  // =================================================================
  function injectArchiveButton(){
    const doneSection = document.querySelector('section.column[data-status="Done"]');
    const h2 = doneSection?.querySelector('h2');
    if (!h2 || h2.querySelector('#btnArchiveDone')) return;

    const btn = document.createElement('button');
    btn.id = 'btnArchiveDone';
    btn.className = 'btn-archive col-action';
    btn.type = 'button';
    btn.title = 'Mover todas las tareas en "Hecho" a Histórico';
    btn.textContent = 'Archivar hechos';
    btn.addEventListener('click', onArchiveDoneClick);
    h2.appendChild(btn);
  }

  function onArchiveDoneClick(){
    const msg = [
      'Vas a mover TODAS las tareas en “Hecho” al estado HISTÓRICO.',
      'Estas tareas YA NO se mostrarán en el tablero,',
      'pero seguirán en la hoja de cálculo para futuras referencias.'
    ].join(' ');
    if (!confirm(msg)) return;

    const password = prompt('Ingresa la contraseña para archivar:');
    if (password === null) return;

    const btn = document.getElementById('btnArchiveDone');
    const old = btn.textContent;
    btn.disabled = true; btn.textContent = 'Archivando...';

    google.script.run
      .withFailureHandler(err => {
        alert('Error al archivar: ' + (err?.message || err));
        btn.disabled = false; btn.textContent = old;
      })
      .withSuccessHandler(res => {
        alert(`${res?.count || 0} tarea(s) movidas a Histórico.`);
        btn.disabled = false; btn.textContent = old;
        refresh();
      })
      .apiArchiveDone({ password: password, newStatus: 'Historico' });
  }

  // =================================================================
  // CARGA Y RENDER
  // =================================================================
  function refresh() {
    setDebug('Actualizando tareas...');
    google.script.run
      .withFailureHandler(err => {
        setDebug('Error al obtener tareas', String(err));
        alert('Error al cargar las tareas: ' + err);
      })
      .withSuccessHandler(rows => { tasks = Array.isArray(rows) ? rows : []; render(); })
      .apiGetTasks();
  }

  function render() {
    setDebug(`Renderizando ${tasks.length} tareas...`);

    // Ocultar histórico/almacén del tablero
    const visible = tasks.filter(t => !isArchivedStatus(t.status));

    Object.values(columns).forEach(col => { col.innerHTML = ''; });

    const buckets = {
      'Backlog': document.createDocumentFragment(),
      'In Progress': document.createDocumentFragment(),
      'Review': document.createDocumentFragment(),
      'Done': document.createDocumentFragment()
    };

    for (const t of visible) {
      const card = buildCard(t);
      (buckets[t.status] || buckets['Backlog']).appendChild(card);
    }

    columns['Backlog'].appendChild(buckets['Backlog']);
    columns['In Progress'].appendChild(buckets['In Progress']);
    columns['Review'].appendChild(buckets['Review']);
    columns['Done'].appendChild(buckets['Done']);

    Object.values(columns).forEach(col => {
      col.removeEventListener('dragover', onDragOver);
      col.removeEventListener('dragleave', onDragLeave);
      col.removeEventListener('drop', onDrop);
      col.addEventListener('dragover', onDragOver);
      col.addEventListener('dragleave', onDragLeave);
      col.addEventListener('drop', onDrop);
    });
  }

  // =================================================================
  // CONSTRUCCIÓN DE TARJETA
  // =================================================================
  function buildCard(task) {
    const el = document.createElement('article');
    el.className = 'card';
    el.draggable = true;
    el.dataset.id = task.id;

    // Header
    const header = document.createElement('div');
    header.className = 'card-header';

    // Izquierda: #id + título
    const left = document.createElement('div');
    left.className = 'card-head-left';

    const idSpan = document.createElement('span');
    idSpan.className = 'card-id';
    idSpan.textContent = `#${task.id}`;

    const title = document.createElement('h3');
    title.className = 'title';
    title.textContent = task.title || '(Sin título)';
    title.title = task.title || '';

    left.appendChild(idSpan);
    left.appendChild(title);

    // Derecha: bandera (si needsReview), semáforo, avatares, Asignarme
    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.alignItems = 'center';
    right.style.gap = '10px';

    if (task.needsReview) {
      const flag = document.createElement('span');
      flag.className = 'flag';
      flag.title = 'Necesita corrección / revisión';
      flag.textContent = '⚑';
      right.appendChild(flag);
    }

    const prio = document.createElement('span');
    const pClass = getPrioClass(task.priority);
    prio.className = 'prio-dot ' + pClass;
    prio.title = prioTitle(task.priority);
    right.appendChild(prio);

    const avatars = buildAvatars(task);
    if (avatars) right.appendChild(avatars);

    const assignBtn = document.createElement('button');
    assignBtn.className = 'assign-btn';
    assignBtn.type = 'button';
    assignBtn.title = 'Asignarme esta tarea';
    assignBtn.innerHTML = `<span class="plus">+</span>`;
    assignBtn.addEventListener('click', (e) => { e.stopPropagation(); quickAssign(task.id); });
    assignBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); assignBtn.click(); }});
    right.appendChild(assignBtn);

    header.appendChild(left);
    header.appendChild(right);
    el.appendChild(header);

    // Descripción (linkificada) + botón "Expandir"
    if (task.description) {
      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.innerHTML = linkifyHTML(escapeHTML(task.description));
      el.appendChild(desc);

      const more = document.createElement('button');
      more.className = 'expand-desc';
      more.type = 'button';
      more.textContent = 'Expandir';
      more.title = 'Ver descripción completa';
      more.addEventListener('click', () => openDescModal(task.title, task.description));
      el.appendChild(more);
    }

    el.addEventListener('dblclick', () => openModal(task));
    el.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', String(task.id)));
    return el;
  }

  function buildAvatars(task) {
    const list = String(task.assignee || '').split(',').map(s => s.trim()).filter(Boolean);
    if (!list.length) return null;

    const wrap = document.createElement('div');
    wrap.className = 'avatars';

    list.slice(0, 3).forEach(name => {
      const a = document.createElement('div');
      a.className = 'avatar';
      a.title = name;
      a.textContent = initialsFromName(name);
      const {bg, fg, bd} = colorForName(name);
      a.style.background = bg;
      a.style.color = fg;
      a.style.borderColor = bd;
      wrap.appendChild(a);
    });

    if (list.length > 3) {
      const more = document.createElement('div');
      more.className = 'avatar';
      const {bg, fg, bd} = colorForName('more');
      more.style.background = bg;
      more.style.color = fg;
      more.style.borderColor = bd;
      more.title = `${list.length - 3} más`;
      more.textContent = `+${list.length - 3}`;
      wrap.appendChild(more);
    }
    return wrap;
  }

  // =================================================================
  // MODAL DE DESCRIPCIÓN EXPANDIDA
  // =================================================================
  function openDescModal(title, description) {
    const body = $('#descBody', descModal);
    const safe = linkifyHTML(escapeHTML(description || ''));
    body.innerHTML = `<p><strong>${escapeHTML(title || '')}</strong></p><p>${safe}</p>`;
    descModal.showModal();
  }

  // =================================================================
  // FORMULARIO / CRUD
  // =================================================================
  function openModal(task = null) {
    form.reset();
    $('#taskId').value       = task?.id || '';
    $('#title').value        = task?.title || '';
    $('#description').value  = task?.description || '';
    $('#priority').value     = task?.priority || 'Medium';
    $('#assignee').value     = task?.assignee || '';
    $('#status').value       = task?.status || 'Backlog';
    $('#needsReview').checked = !!task?.needsReview;

    // Alineación checkbox (si hiciera falta)
    const needsWrap = document.getElementById('needsWrap');
    if (!needsWrap) {
      const chk = $('#needsReview');
      const label = document.querySelector('label[for="needsReview"]');
      const row = document.createElement('div');
      row.id = 'needsWrap';
      row.className = 'check-row';
      chk.parentElement.insertBefore(row, chk);
      row.appendChild(chk);
      if (label) row.appendChild(label);
    }

    injectExpandInForm();

    $('#modalTitle').textContent = task ? `Editar tarea #${task.id}` : 'Nueva tarea';
    btnDelete.style.display = task ? 'inline-block' : 'none';
    modal.showModal();
  }

  function injectExpandInForm() {
    const area = $('#description');
    if (!area) return;
    let btn = document.getElementById('btnExpandFormDesc');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'btnExpandFormDesc';
      btn.type = 'button';
      btn.className = 'expand-desc';
      btn.style.marginTop = '6px';
      btn.textContent = 'Expandir';
      area.parentElement.appendChild(btn);
      btn.addEventListener('click', () => openDescModal($('#title').value, area.value));
    } else if (btn.parentElement !== area.parentElement) {
      area.parentElement.appendChild(btn);
    }
  }

  function onSubmit(e) {
    e.preventDefault();
    const payload = {
      id: Number($('#taskId').value || 0),
      title: $('#title').value.trim(),
      description: $('#description').value.trim(),
      priority: $('#priority').value,
      assignee: $('#assignee').value.trim(),
      status: $('#status').value,
      needsReview: $('#needsReview').checked
    };
    if (!payload.title) return alert('El título es obligatorio.');

    const password = prompt('Ingresa la contraseña para guardar:');
    if (password === null) return;

    const btn = $('#btnSave');
    const txt = btn.textContent;
    btn.textContent = 'Guardando...'; btn.disabled = true;

    const finish = (err = null) => {
      btn.textContent = txt; btn.disabled = false;
      if (err) return alert('Error: ' + err);
      modal.close(); refresh();
    };

    if (payload.id) {
      google.script.run
        .withFailureHandler(finish)
        .withSuccessHandler(() => finish())
        .apiUpdateTask({ task: payload, password });
    } else {
      google.script.run
        .withFailureHandler(finish)
        .withSuccessHandler(() => finish())
        .apiCreateTask({ task: payload, password });
    }
  }

  function onDelete() {
    const id = Number($('#taskId').value);
    if (!id || !confirm('¿Seguro que quieres eliminar esta tarea?')) return;
    const password = prompt('Ingresa la contraseña para ELIMINAR:');
    if (password === null) return;

    google.script.run
      .withFailureHandler(err => alert('Error al eliminar: ' + err))
      .withSuccessHandler(() => { modal.close(); refresh(); })
      .apiDeleteTask({ id, password });
  }

  // =================================================================
  // DRAG & DROP
  // =================================================================
  function onDragOver(e){ e.preventDefault(); e.currentTarget.classList.add('dragover'); }
  function onDragLeave(e){ e.currentTarget.classList.remove('dragover'); }
  function onDrop(e){
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const status = e.currentTarget.closest('.column').dataset.status;
    e.currentTarget.classList.remove('dragover');
    const card = document.querySelector(`[data-id="${id}"]`);
    if (card) e.currentTarget.appendChild(card);

    google.script.run
      .withFailureHandler(() => refresh())
      .withSuccessHandler(refresh)
      .apiMoveTask(Number(id), status);
  }

  // =================================================================
  // ACCIONES
  // =================================================================
  function quickAssign(taskId) {
    const nombre = prompt('Escribe tu nombre para asignarte:', '');
    if (!nombre || !taskId) return;
    google.script.run
      .withFailureHandler(err => alert('Error: ' + err.message))
      .withSuccessHandler(refresh)
      .apiAssignTaskToUser(Number(taskId), nombre.trim());
  }

  // =================================================================
  // HELPERS
  // =================================================================
  function isArchivedStatus(s){
    return /^(historico|histórico|almacen|almac[eé]n|archive|archived)$/i.test(String(s||''));
  }
  function getPrioClass(priority){
    const p = String(priority || '').toLowerCase();
    if (p.startsWith('h')) return 'alta';
    if (p.startsWith('m')) return 'media';
    return 'baja';
  }
  function prioTitle(priority){
    const p = String(priority || '').toLowerCase();
    if (p.startsWith('h')) return 'Alta';
    if (p.startsWith('m')) return 'Media';
    if (p.startsWith('l')) return 'Baja';
    return 'Prioridad';
  }
  function initialsFromName(name){
    const s = String(name || '').trim();
    if (!s) return '—';
    const parts = s.split(/\s+/).filter(Boolean);
    if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
    return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
  }
  function setDebug(msg, obj){
    if (!debugPanel) return;
    const time = new Date().toLocaleTimeString();
    let content = `[${time}] ${msg}`;
    if (obj) content += `\n${JSON.stringify(obj, null, 2)}`;
    debugPanel.textContent = content;
  }

  // Colores determinísticos por nombre
  function colorForName(name){
    const palette = [
      ['#A7F3D0','#06251b','#069B66'], // mint
      ['#BFDBFE','#0B2847','#5F9DF7'], // blue
      ['#FBCFE8','#3B0A2E','#D24F9C'], // pink
      ['#FDE68A','#3A2A00','#D9A800'], // yellow
      ['#C7D2FE','#0F1544','#7C89F9'], // indigo
      ['#FCA5A5','#3A0606','#E05757'], // red
      ['#FDBA74','#3A1E05','#D97A23'], // orange
      ['#DDD6FE','#210B47','#9D7FF9'], // violet
      ['#BBF7D0','#05290F','#1FB76E'], // green
      ['#BAE6FD','#062236','#1E98C9']  // sky
    ];
    let h = 0;
    const s = String(name||'');
    for (let i=0;i<s.length;i++) h = (h*33 + s.charCodeAt(i)) % 2147483647;
    const idx = h % palette.length;
    const [bg, fg, bd] = palette[idx];
    return { bg, fg, bd };
  }

  // Safe linkify
  function escapeHTML(str){
    return String(str || '')
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }
  function linkifyHTML(safe){
    const urlRE = /\b(https?:\/\/[^\s<]+[^\s<\.)])/gi;
    return safe.replace(urlRE, (m) =>
      `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`
    );
  }
})();

// === Editor modal para la descripción (versión estable) ===
(function(){
  let editorModal, isEditorOpen = false, suppressFocus = false, currentTextarea = null;

  function ensureEditor(){
    if (editorModal) return editorModal;
    editorModal = document.createElement('dialog');
    editorModal.id = 'editorModal';
    editorModal.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid #444">
        <strong>Editor de descripción</strong>
        <div style="display:flex;gap:8px">
          <button type="button" class="btn" id="edrLinkBtn">Link</button>
          <button type="button" class="btn primary" id="edrSaveBtn">Guardar</button>
          <button type="button" class="btn" id="edrCancelBtn">Cancelar</button>
        </div>
      </div>
      <div id="editorArea" contenteditable="true"
           style="min-height:50vh;padding:16px;white-space:pre-wrap;line-height:1.5;outline:none"></div>
    `;
    document.body.appendChild(editorModal);

    // Eventos de los botones (con preventDefault y stopPropagation)
    editorModal.querySelector('#edrSaveBtn').addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      closeEditor(true);
    });
    editorModal.querySelector('#edrCancelBtn').addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      closeEditor(false);
    });
    editorModal.querySelector('#edrLinkBtn').addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const url = prompt('Pega la URL (https://...)');
      if (!url) return;
      insertTextAtCaret(' ' + url + ' ');
    });
    return editorModal;
  }

  function openEditor(textarea){
    if (isEditorOpen) return;
    currentTextarea = textarea;
    const modal = ensureEditor();
    modal.querySelector('#editorArea').innerText = textarea.value || '';
    isEditorOpen = true;
    modal.showModal();
  }

  function closeEditor(save){
    if (!editorModal) return;
    if (save && currentTextarea) {
      const txt = editorModal.querySelector('#editorArea').innerText.replace(/\u00A0/g,' ');
      currentTextarea.value = txt; // guardamos texto plano
    }
    try { editorModal.close(); } catch(_) { editorModal.removeAttribute('open'); }
    isEditorOpen = false;
    // Evita que el foco de regreso al textarea vuelva a abrir el editor
    suppressFocus = true;
    setTimeout(()=>{ suppressFocus = false; currentTextarea = null; }, 250);
  }

  // Inserta texto en la posición del cursor dentro del editor
  function insertTextAtCaret(text){
    const area = editorModal.querySelector('#editorArea');
    area.focus();
    const sel = window.getSelection && window.getSelection();
    if (sel && sel.rangeCount) {
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(document.createTextNode(text));
      // Colocar el cursor al final
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
    } else {
      area.appendChild(document.createTextNode(text));
    }
  }

  // 👉 Abrimos SOLO con click (quitamos el focusin que reabría el editor)
  document.addEventListener('click', (ev) => {
    const t = ev.target;
    if (t && t.id === 'description' && t.tagName === 'TEXTAREA') {
      if (isEditorOpen || suppressFocus) return;
      ev.preventDefault();
      openEditor(t);
    }
  });

  // (Opcional) si tenías un botón "Abrir editor", seguirá funcionando:
  window.openEditor = openEditor;
})();

function renderCard(t){
  const card = document.createElement('article');
  card.className = 'task';
  card.draggable = true;
  card.dataset.id = String(t.id);
  card.dataset.status = String(t.status || 'Backlog');

  const flag = (t.needsReview ? `<span class="flag" title="Necesita corrección">⚑</span>` : '');
  const safeTitle = escapeHTML(t.title || '');
  card.innerHTML = `
    <header class="task-hd">
      <h4 class="task-title">${safeTitle} ${flag}</h4>
      <button class="btn-icon assign" title="Asignarme" data-id="${t.id}">👤</button>
    </header>
    <div class="task-desc">${linkifyHTML(escapeHTML(t.description || ''))}</div>
    <footer class="task-ft">
      <span class="pill ${String(t.priority||'Medium').toLowerCase()}">${t.priority||'Medium'}</span>
      <span class="assignee">${renderAssignee(t.assignee||'')}</span>
    </footer>
  `;

  // Asignarme
  card.querySelector('.assign')?.addEventListener('click', () => onAssign(t.id));

  // Descripción ampliada
  card.querySelector('.task-desc')?.addEventListener('click', () => {
    $('#descBody', document).innerHTML = linkifyHTML(escapeHTML(t.description || ''));
    document.getElementById('descModal').showModal();
  });

  // Drag start: recordamos desde qué status salió
  card.addEventListener('dragstart', ev => {
    dragging = { card, fromStatus: String(t.status || 'Backlog') };
    ev.dataTransfer.setData('text/plain', String(t.id));
    ev.dataTransfer.effectAllowed = 'move';
  });
  card.addEventListener('dragend', () => { dragging = null; });

  enableDropzones(); // se auto-protege para no duplicar listeners
  return card;
}

function enableDropzones(){
  document.querySelectorAll('.col-body').forEach(zone => {
    if (zone.dataset.dndBound === '1') return; // evita duplicados
    zone.dataset.dndBound = '1';

    zone.addEventListener('dragover', e => e.preventDefault());
    zone.addEventListener('dragenter', () => zone.classList.add('drop-hover'));
    zone.addEventListener('dragleave', () => zone.classList.remove('drop-hover'));

    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('drop-hover');

      const id = Number(e.dataTransfer.getData('text/plain') || 0);
      const section = zone.closest('section');
      const newStatus = section?.getAttribute('data-status') || 'Backlog';
      if (!id) return;

      // UI optimista: mover tarjeta
      const card = dragging?.card ?? [...board.querySelectorAll('.task')].find(el => el.dataset.id == String(id));
      if (card) zone.appendChild(card);

      // Persistir en backend
      persistMove(id, newStatus, dragging);
      dragging = null;
    });
  });
}

function persistMove(id, newStatus, dragInfo){
  const fromStatus = dragInfo?.fromStatus;
  const cardEl = dragInfo?.card;

  google.script.run
    .withSuccessHandler(() => {
      // refrescamos para asegurar consistencia (y actualizar colores / banderas)
      refresh();
    })
    .withFailureHandler(err => {
      alert('No se pudo mover: ' + (err.message || err));
      // Revertir visualmente si teníamos el origen
      if (cardEl && fromStatus && columns[fromStatus]) {
        columns[fromStatus].appendChild(cardEl);
      }
    })
    .apiMoveTaskStatus(Number(id), newStatus);
}
</script>
